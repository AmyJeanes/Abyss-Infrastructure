name: Proxies

on:
  workflow_dispatch:
  workflow_call:
  push:
    branches: [main]
    paths:
      - 'kubernetes/charts/homeassistant-proxy/**'
      - 'kubernetes/charts/octoprint-proxy/**'
      - 'kubernetes/charts/outlookcal-proxy/**'
      - '.github/workflows/proxies.yaml'

jobs:
  deploy-proxies:
    name: Deploy Proxies
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

      - name: Connect to Kubernetes
        uses: ./.github/actions/connect-k8s
        with:
          kubeconfig: "${{ secrets.KUBECONFIG }}"
          hostname: kubernetes-api.${{ vars.HOST }}
          serviceTokenId: ${{ vars.CLOUDFLARE_TUNNEL_SERVICE_TOKEN_ID }}
          serviceTokenSecret: ${{ secrets.CLOUDFLARE_TUNNEL_SERVICE_TOKEN_SECRET }}

      - name: Install homeassistant-proxy
        run: |
          helm dependency update .
          helm upgrade --install --wait --atomic --debug \
            homeassistant-proxy . \
            --namespace default \
            -f values.yaml \
            --set ingress.host="homeassistant.${{ vars.HOST }}"
        working-directory: kubernetes/charts/homeassistant-proxy

      - name: Install octoprint-proxy
        run: |
          helm dependency update .
          helm upgrade --install --wait --atomic --debug \
            octoprint-proxy . \
            --namespace default \
            -f values.yaml \
            --set ingress.host="octoprint.${{ vars.HOST }}"
        working-directory: kubernetes/charts/octoprint-proxy

      - name: Install outlookcal-proxy
        run: |
          helm dependency update .
          helm upgrade --install --wait --atomic --debug \
            outlookcal-proxy . \
            --namespace default \
            -f values.yaml \
            --set ingress.host="outlookcalproxy.${{ vars.HOST }}"
        working-directory: kubernetes/charts/outlookcal-proxy

      - name: Disconnect from Kubernetes
        if: always()
        uses: ./.github/actions/disconnect-k8s